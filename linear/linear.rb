require 'prime'

def berlekamp_massey(s, q)
  b, c = [1], [1] + [0] * (s.size - 1)
  l, m, a = 0, -1, 1
  s.size.times{|n|
    d = (0..l).inject(0) {|sum, i| (sum + c[i] * s[n - i]) % q}
    next if d == 0
    t = c[0..l]
    (0...[s.size - n + m, b.size].min).each{|j|
      c[n - m + j] = (c[n - m + j] - d * a * b[j]) % q
    }
    b, l, m, a = t, n + 1 - l, n, mod_inv(d, q) if 2 * l <= n
  }
  c[0..l]
end

def euclid(a, b)
  return [0, 1] if a == 0
  q, r = b.divmod(a)
  x, y = euclid(r, a)
  [y - q * x, x]
end

# x^(-1) (mod n)
def mod_inv(x, n)
  euclid(x, n)[0]
end

# x % n1 = r1, x % n2 = r2, |x| <= n1 * n2 / 2 となる x
def chinese(n1, r1, n2, r2)
  x = (n1 * (r2 - r1) * mod_inv(n1, n2) + r1) % (n = n1 * n2)
  2 * x > n ? x - n : x
end

# f を多項式として f=0 が数列 s を生成する漸化式の特性方程式となっているか
def test(f, s)
  (0..s.size - f.size).all?{|i|
    f.each_with_index.inject(0) {|sum, (fj, j)|
      sum + fj * s[f.size + i - j - 1]
    } == 0
  }
end

# 数列 s を生成する漸化式の特性方程式 f=0 の f を返す
def polynomial(s)
  f, n = [], 1
  Prime.each{|q|
    c = berlekamp_massey(s, q)
    if c.size != f.size then
      f, n = c, q if c.size > f.size
      next
    end
    f = (0...f.size).map {|i| chinese(n, f[i], q, c[i])}
    return f if test(f, s)
    n *= q
  }
end

a = [1, 2, 3, 5, 8]
p polynomial(a)  # [1, -1, -1]

# A339850
a =
[1,4,13,44,148,498,1676,5640,18980,63872,214944,
 723336,2434192,8191616,27566672,92768192,
 312186304,1050578720,3535439040,11897565568,
 40038044736,134737229824,453421769728,
 1525868548224,5134898635008,17280115002368,
 58151561641216]
p polynomial(a)  # [1, -2, -4, -2]

# A339851
a =
[1,13,80,549,3851,26499,183521,1269684,8782833,
 60764640,420375910,2908245096,20119820809,
 139192751951,962962619849,6661962019139,
 46088745527485,318850883829314,2205872265781839,
 15260652269262421,105576152878533354,
 730396306808551777,5053023343572544589]
p polynomial(a)  # [1, -3, -21, -44, 5, 47, 26, -83, 81, -39, 10, -1]

# A339852
a =
[1, 44, 549, 7104, 104100, 1475286, 20842802, 295671198, 4190083085, 59374628434, 841470846944, 11925007688342, 168996943899738, 2394974040514288, 33940795571394262, 480998063196253650, 6816550836218124869, 96601974078400509612, 1369012239935377295854, 19401203058253673198258, 274947636268050621400764, 3896469848341602644039976, 55219522831075639350876744, 782553393257523404353337072, 11090096073215866151573834374, 157165289898796544200350430624, 2227296155585971455156172389428, 31564527815820044279227403214372, 447322379530320420841684880901414, 6339309505792160540792742125116082, 89838664125016756891020466929250678, 1273164776762062815909549693318243474, 18042883479789198113990404577161681809, 255697966364718372241431025079220607096, 3623669690949891543192262204257739772862, 51353486364374613503346584879236847854988, 727765162581557315040161248852078827853081, 10313654814189762303056253668716854185252586, 146161813034488437333820397061916438175592212, 2071358405376983398185997850226728372034043804, 29354627959585341474036727576650340081950823933, 416004386497682288307056830557907216363761106862, 5895480938255353627710467301187720251497974385188, 83548867803887608576976607143625988947392154203778, 1184027797633283033221966563561614043398289352682144, 16779662758076176801870213809755429439563758422592412, 237796006848457825648232491588908625029253670787265436, 3369968853864797541086858261144062774171732622929058582, 47758119349986336878326531031237376223217715140497002775, 676812772685360291344623917527676073587684880479088934054, 9591573862302352835797028559545410935234779475814019718300, 135928713033863273181505022419321331310585400335777312874708, 1926338189362307750734777981307625525018829008991251637814497, 27299447901571800889178346656727151511511978594896500845799952, 386879032895746495920277022446451830359106405140348690494767824, 5482725754528183923614470375122938657759732050919141689393339872, 77699433526724830105096960795371805411909471621169951816163593081, 1101131488363758604270755144719287259798186029232159012927563546302, 15604882811007218071739532939721435094886837734655636293706882937208, 221147401666915428250629075680373839399016530705111352585955739707676, 3134030153019225200201026339985842442619738788671019120021078638856335, 44414471641984215530599892450663513202243152118966616009966199373793572, 629427668185079898142883861288417965173359250226710241476963108048806246, 8920047336607418998867049464249081129886585136015835206824839116580805852, 126412054170965962735107290621838559224962681329960673807279035539876598803, 1791471147708162727742502772561187483803019477978654371413798612255317170404, 25388155378998045323475411963454735749219946386285921066750507195817804671286, 359792807365462708449804154172161244283011721186001874057463031758678792692322, 5098868440792951837793362140391503785686173919700589258094269903065440360004518]
p polynomial(a)  # [1, -8, -62, -384, 160, 1628, 11310, -9700, 16019, -102564, 98380, -263340, 429661, -174728, 361330, -147404, -284641, -24764, -182412, 156248, 138559, -14756, -14496, 3660, 2640, -328, -80, 8, 0, 0, 0]

